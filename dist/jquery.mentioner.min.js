/*! jquery.mentioner - v0.0.1 - 2015-06-17
* Copyright (c) 2015 MediaSQ; Licensed MIT */
!function(a){"use strict";var b={ESC:27,UP:38,DOWN:40,RETURN:13},c={WRAPPER:"js-mentioner-wrapper",DROPDOWN:"js-mentioner-dropdown",DROPDOWN_ITEM:"js-mentioner-dropdown-item"},d=function(b,c){this.$root=b,this.editor=c.editor,this.mentionSymbol=c.mentionSymbol||"@",this.matcher=c.matcher||a.noop,this.mentionables=(c.requester?c.requester():[]).sort(function(a,b){return a.name.localeCompare(b.name)}),this.buildDOM(),this.attachEvents()};d.prototype.buildDOM=function(){var b=a('<div class="'+c.WRAPPER+' mentioner"></div>');this.$root.wrap(b),this.$root.addClass("mentioner__composer composer");var d=a('<ul class="'+c.DROPDOWN+' mentioner__dropdown mentioner__dropdown--hidden dropdown"></ul>');this.$parentWrapper().append(d)},d.prototype.attachEvents=function(){this.$root.on("blur",this.onRootBlur()),this.$root.on("keydown",this.onRootKeydown()),this.editor.subscribe("editableInput",this.onEditableInput()),this.$dropdown().on("mousedown","."+c.DROPDOWN_ITEM,this.onDropdownItemMousedown())},d.prototype.onRootKeydown=function(){var a=this,c=function(b){a.isDropdownDisplayed()&&(event.preventDefault(),b.call(a))};return function(a){switch(a.keyCode){case b.ESC:c(function(){this.hideDropdown()});break;case b.DOWN:c(function(){this.selectOtherDropdownOption(function(a){return 0===a.next().length?a.siblings().first():a.next()})});break;case b.UP:c(function(){this.selectOtherDropdownOption(function(a){return 0===a.prev().length?a.siblings().last():a.prev()})});break;case b.RETURN:c(function(){this.getSelectedDropdownOption().trigger("mousedown")});break;default:return!0}}},d.prototype.onRootBlur=function(){var a=this;return function(){a.hideDropdown()}},d.prototype.onEditableInput=function(){var a=this;return function(){var b=a.getRootText(),c=b.lastIndexOf(a.mentionSymbol);if(a.canBeSearchable(b,c)){var d=b.slice(c+1);a.search(d)}else a.hideDropdown()}},d.prototype.onDropdownItemMousedown=function(){var b=this;return function(c){c.preventDefault();var d=a(this).data("mentionable"),e=b.editor.exportSelection(),f=b.getRootText().slice(0,e.end),g=f.lastIndexOf(b.mentionSymbol),h=b.getWidthForInput(d.name),i='<input value="'+d.name+'" style="width:'+h+'px;" class="composer__mention" readonly/>';b.editor.importSelection({start:g,end:e.end}),b.editor.pasteHTML(i,{cleanAttrs:[]}),b.hideDropdown()}},d.prototype.getWidthForInput=function(b){var c=a("<span></span>").text(b);this.$root.append(c);var d=c.width();return c.remove(),d},d.prototype.getRootText=function(){var b=this.$root.find("p");return a.makeArray(b).map(function(b){return a(b).text()}).join("\n")},d.prototype.canBeSearchable=function(a,b){if(-1===b)return!1;var c=a.charAt(b-1),d=a.charAt(b+1),e=this.isValidPreMentionSymbolChar(c),f=this.isValidPostMentionSymbolChar(d);return e&&f},d.prototype.isValidPreMentionSymbolChar=function(a){return!/\w/g.test(a)},d.prototype.isValidPostMentionSymbolChar=function(a){return" "!==a},d.prototype.search=function(a){var b=this,c=b.cleanEntities(a),d=b.mentionables.filter(function(a){return b.matcher.call(b,a,c)});d.length>0?b.showDropdown(d):b.hideDropdown()},d.prototype.cleanEntities=function(a){var b=a.indexOf(String.fromCharCode(160));return b>-1?a.slice(0,b)+" "+a.slice(b+1):a},d.prototype.$parentWrapper=function(){return this.$root.parent()},d.prototype.$dropdown=function(){return this.$parentWrapper().find("."+c.DROPDOWN)},d.prototype.getDropdownOptions=function(){return this.$dropdown().find("."+c.DROPDOWN_ITEM)},d.prototype.showDropdown=function(a){var b=this.getDropdownOptionsToAppend(a),c=this.$dropdown();c.append(b),c.attr("style",this.getStyleForDropdown()),c.removeClass("mentioner__dropdown--hidden"),this.removeOrphanDropdownOptions(a),this.checkSelectedDropdownOption()},d.prototype.getDropdownOptionsToAppend=function(b){var c=this;return b.map(function(b){var d=c.getDropdownOptions().filter(function(){var c=a(this).data("mentionable");return c.id===b.id});return 0!==d.length?d:c.createDropdownOption(b)})},d.prototype.removeOrphanDropdownOptions=function(b){this.getDropdownOptions().each(function(){var c=a(this).data("mentionable"),d=b.filter(function(a){return a.id===c.id})[0];d||a(this).remove()})},d.prototype.createDropdownOption=function(b){var d=a('<li class="'+c.DROPDOWN_ITEM+' dropdown__item"></li>'),e=a('<p class="dropdown__item__name">'+b.name+"</p>"),f=a(['<div class="dropdown__item__avatar">','<img class="dropdown__item__avatar__image" src="'+b.avatar+'" />',"</div>"].join("\n"));return d.append(f),d.append(e),d.data("mentionable",b),d},d.prototype.checkSelectedDropdownOption=function(){var b=this.getSelectedDropdownOption();if(0===b.length){var c=a(),d=this.getDropdownOptions().first();this.selectDropdownOption(c,d)}},d.prototype.getSelectedDropdownOption=function(){return a(".dropdown__item--selected")},d.prototype.getStyleForDropdown=function(){var a=this.$root.outerHeight()+5;return"top: "+a+"px;"},d.prototype.hideDropdown=function(){var a=this.$dropdown();a.addClass("mentioner__dropdown--hidden")},d.prototype.isDropdownDisplayed=function(){return!this.$dropdown().hasClass("mentioner__dropdown--hidden")},d.prototype.selectOtherDropdownOption=function(a){var b=this.getSelectedDropdownOption(),c=a.call(this,b);this.selectDropdownOption(b,c)},d.prototype.selectDropdownOption=function(a,b){a.removeClass("dropdown__item--selected"),b.addClass("dropdown__item--selected")},a.fn.mentioner=function(b){return b=b||{},this.each(function(){var c=a(this);void 0===c.data("mentioner")&&c.data("mentioner",new d(c,b))})}}(jQuery);