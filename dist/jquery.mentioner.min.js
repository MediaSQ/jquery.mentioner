/*! jquery.mentioner - v0.0.1 - 2015-06-23
* Copyright (c) 2015 MediaSQ; Licensed MIT */
!function(a){"use strict";var b={ESC:27,UP:38,DOWN:40,RETURN:13},c={WRAPPER:"js-mentioner-wrapper",DROPDOWN:"js-mentioner-dropdown",DROPDOWN_ITEM:"js-mentioner-dropdown-item"},d=function(b,c){this.$root=b,this.lastKeyDown=null,this.editor=c.editor,this.minQueryLength=c.minQueryLength||1,this.maxMentionablesToShow=c.maxMentionablesToShow||5,this.mentionSymbol=c.mentionSymbol||"@",this.matcher=c.matcher||a.noop,this.mentionables=(c.requester?c.requester():[]).sort(function(a,b){return a.name.localeCompare(b.name)}),this.buildDOM(),this.attachEvents()};d.prototype.buildDOM=function(){var b=a('<div class="'+c.WRAPPER+' mentioner"></div>');this.$root.wrap(b),this.$root.addClass("mentioner__composer composer");var d=a('<ul class="'+c.DROPDOWN+' mentioner__dropdown mentioner__dropdown--hidden dropdown"></ul>');this.$parentWrapper().append(d)},d.prototype.attachEvents=function(){this.editor.subscribe("editableBlur",this.onRootBlur()),this.editor.subscribe("editableInput",this.onEditableInput()),this.editor.subscribe("editableKeyup",this.onEditableKeyup()),this.editor.subscribe("editableKeydown",this.onRootKeydown()),this.editor.subscribe("editableKeydownEnter",this.onRootKeydownEnter()),this.$dropdown().on("mousedown","."+c.DROPDOWN_ITEM,this.onDropdownItemMousedown())},d.prototype.onRootBlur=function(){var a=this;return function(){a.hideDropdown()}},d.prototype.onEditableInput=function(){var a=this;return function(){var c=a.$root.text(),d=a.editor.exportSelection(),e=c.slice(0,d.end),f=e.lastIndexOf(a.mentionSymbol),g=e.slice(f+1);f>-1&&a.lastKeyDown!==b.RETURN&&g.length>=a.minQueryLength?a.search(g):a.hideDropdown()}},d.prototype.dropdownEventWrapper=function(a,b){this.isDropdownDisplayed()&&(a.preventDefault(),b.call(this))},d.prototype.onEditableKeyup=function(){var a=this;return function(c){c.keyCode===b.RETURN&&a.dropdownEventWrapper(c,function(){this.getSelectedDropdownOption().trigger("mousedown")})}},d.prototype.onRootKeydown=function(){var a=this;return function(c){switch(a.lastKeyDown=c.keyCode,c.keyCode){case b.ESC:a.dropdownEventWrapper(c,function(){this.hideDropdown()});break;case b.DOWN:a.dropdownEventWrapper(c,function(){this.selectOtherDropdownOption(function(a){return 0===a.next().length?a.siblings().first():a.next()})});break;case b.UP:a.dropdownEventWrapper(c,function(){this.selectOtherDropdownOption(function(a){return 0===a.prev().length?a.siblings().last():a.prev()})});break;default:return!0}}},d.prototype.onRootKeydownEnter=function(){var b=this;return function(c){b.dropdownEventWrapper(c,a.noop)}},d.prototype.onDropdownItemMousedown=function(){var b=this;return function(c){c.preventDefault();var d=a(this).data("mentionable"),e=(new Date).getTime(),f=b.getWidthForInput(d.name),g='<input id="'+e+'" value="'+d.name+'" style="width:'+f+'px;" class="composer__mention js-mention" readonly />';b.editor.pasteHTML(g,{forcePlainText:!1,cleanAttrs:[]});var h=b.editor.exportSelection(),i=b.clearMentionTextTrigger(h);b.addBlankAfterMention(e),b.recalculateSelection(h,i),b.hideDropdown()}},d.prototype.recalculateSelection=function(a,b){var c=1,d=a.end-b.length+c;this.editor.importSelection({start:d,end:d})},d.prototype.addBlankAfterMention=function(b){var c=this.$root.find("#"+b),d=a("<span>&nbsp;</span>");d.insertAfter(c),d.replaceWith("&nbsp;")},d.prototype.clearMentionTextTrigger=function(a){var b=this.$root.text(),c=b.slice(0,a.end),d=c.lastIndexOf(this.mentionSymbol),e=c.slice(d,a.end),f=this.clearEntities(e,{160:function(a,b){return b.length>1?this.replaceAt(b,a,"&nbsp;"):"&nbsp;"}}),g=new RegExp("("+f+")(<input)"),h=this.$root.html().replace(g,function(a,b,c){return c});return this.$root.html(h),e},d.prototype.getWidthForInput=function(b){var c=a('<span style="visibility: hidden;"></span>').text(b);this.$root.append(c);var d=c.width();return c.remove(),d},d.prototype.search=function(a){var b=this,c=b.clearEntities(a),d=b.mentionables.filter(function(a){return b.matcher.call(b,a,c)}).slice(0,b.maxMentionablesToShow);d.length>0?b.showDropdown(d):b.hideDropdown()},d.prototype.replaceAt=function(a,b,c){return a.slice(0,b)+c+a.slice(b+1)},d.prototype.clearEntities=function(b,c){var d=a.extend({},{160:function(a,b){return b.length>1?this.replaceAt(b,a," "):" "},10:function(a,b){return b.slice(0,a)}},c),e=b;for(var f in d){var g=d[f],h=String.fromCharCode(parseInt(f)),i=e.indexOf(h);i>-1&&(e=g.call(this,i,e))}return e},d.prototype.$parentWrapper=function(){return this.$root.parent()},d.prototype.$dropdown=function(){return this.$parentWrapper().find("."+c.DROPDOWN)},d.prototype.getDropdownOptions=function(){return this.$dropdown().find("."+c.DROPDOWN_ITEM)},d.prototype.showDropdown=function(a){var b=this.getDropdownOptionsToAppend(a),c=this.$dropdown();c.append(b),c.attr("style",this.getStyleForDropdown()),c.removeClass("mentioner__dropdown--hidden"),this.removeOrphanDropdownOptions(a),this.checkSelectedDropdownOption()},d.prototype.getDropdownOptionsToAppend=function(b){var c=this;return b.map(function(b){var d=c.getDropdownOptions().filter(function(){var c=a(this).data("mentionable");return c.id===b.id});return 0!==d.length?d:c.createDropdownOption(b)})},d.prototype.removeOrphanDropdownOptions=function(b){this.getDropdownOptions().each(function(){var c=a(this).data("mentionable"),d=b.filter(function(a){return a.id===c.id})[0];d||a(this).remove()})},d.prototype.createDropdownOption=function(b){var d=a('<li class="'+c.DROPDOWN_ITEM+' dropdown__item"></li>'),e=a('<p class="dropdown__item__name">'+b.name+"</p>"),f=a(['<div class="dropdown__item__avatar">','<img class="dropdown__item__avatar__image" src="'+b.avatar+'" />',"</div>"].join("\n"));return d.append(f),d.append(e),d.data("mentionable",b),d},d.prototype.checkSelectedDropdownOption=function(){var b=this.getSelectedDropdownOption();if(0===b.length){var c=a(),d=this.getDropdownOptions().first();this.selectDropdownOption(c,d)}},d.prototype.getSelectedDropdownOption=function(){return this.$dropdown().find(".dropdown__item--selected")},d.prototype.getStyleForDropdown=function(){var a=this.$root.outerHeight()+10,b=this.$root.css("padding-left"),c=this.$root.offset().left-parseInt(b);return"top: "+a+"px; left: "+c+"px;"},d.prototype.hideDropdown=function(){var a=this.$dropdown();a.addClass("mentioner__dropdown--hidden")},d.prototype.isDropdownDisplayed=function(){return!this.$dropdown().hasClass("mentioner__dropdown--hidden")},d.prototype.selectOtherDropdownOption=function(a){var b=this.getSelectedDropdownOption(),c=0===b.siblings().length?b:a.call(this,b);this.selectDropdownOption(b,c)},d.prototype.selectDropdownOption=function(a,b){a.removeClass("dropdown__item--selected"),b.addClass("dropdown__item--selected")},a.fn.mentioner=function(b){return b=b||{},this.each(function(){var c=a(this);void 0===c.data("mentioner")&&c.data("mentioner",new d(c,b))})}}(jQuery);