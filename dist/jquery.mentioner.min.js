/*! jquery.mentioner - v0.0.1 - 2016-05-09
* Copyright (c) 2016 MediaSQ; Licensed MIT */
!function(a){"use strict";var b={ESC:27,UP:38,DOWN:40,RETURN:13},c={WRAPPER:"js-mentioner-wrapper",DROPDOWN:"js-mentioner-dropdown",DROPDOWN_ITEM:"js-mentioner-dropdown-item",DROPDOWN_HELP_ITEM:"js-mentioner-dropdown-help-item"},d=6,e=function(a,b){this.$root=a,this.lastKeyDown=null,this.editor=b.editor,this.minQueryLength=b.minQueryLength||1,this.maxMentionablesToShow=b.maxMentionablesToShow||5,this.mentionSymbol=b.mentionSymbol||"@",this.dropdownHelpMessage=b.dropdownHelpMessage||"Type to search for results",this.matcher=b.matcher||this.defaultMatcher,this.mentionables=[],b.requester&&b.requester.call(this,this.loadMentionables.bind(this)),this.buildDOM(),this.attachEvents()};e.prototype.loadMentionables=function(a){this.mentionables=a.sort(function(a,b){return a.name.localeCompare(b.name)})},e.prototype.defaultMatcher=function(a,b){var c=new RegExp("^"+b.toLowerCase()),d=!1,e=a.name.toLowerCase(),f=[e];return f.push.apply(f,e.split(" ")),f.forEach(function(a){c.test(a)&&(d=!0)}),d},e.prototype.buildDOM=function(){var b=a('<div class="'+c.WRAPPER+' mentioner"></div>');this.$root.wrap(b),this.$root.addClass("mentioner__composer");var d=a('<ul class="'+c.DROPDOWN+' mentioner__dropdown mentioner__dropdown--hidden"></ul>');this.$parentWrapper().append(d)},e.prototype.attachEvents=function(){this.editor.subscribe("editableBlur",this.onRootBlur.bind(this)),this.editor.subscribe("editableInput",this.onEditableInput.bind(this)),this.editor.subscribe("editableKeyup",this.onEditableKeyup.bind(this)),this.editor.subscribe("editableKeydown",this.onRootKeydown.bind(this)),this.editor.subscribe("editableKeydownEnter",this.onRootKeydownEnter.bind(this)),this.$dropdown().on("mousedown","."+c.DROPDOWN_HELP_ITEM,this.onDropdownHelpItemMousedown.bind(this)),this.$dropdown().on("mousedown","."+c.DROPDOWN_ITEM,this.onDropdownItemMousedown())},e.prototype.onRootBlur=function(){this.hideDropdown()},e.prototype.onEditableInput=function(){var a=this.$root.text(),c=this.editor.exportSelection(),d=a.slice(0,c.end),e=d.lastIndexOf(this.mentionSymbol),f=d.slice(e+1);e>-1&&this.lastKeyDown!==b.RETURN?f.length>=this.minQueryLength?this.search(f):this.showDropdownHelp():this.hideDropdown()},e.prototype.dropdownEventWrapper=function(a,b){this.isDropdownDisplayed()&&(a.preventDefault(),b.call(this))},e.prototype.onEditableKeyup=function(a){a.keyCode===b.RETURN&&this.dropdownEventWrapper(a,function(){this.getSelectedDropdownOption().trigger("mousedown")})},e.prototype.onRootKeydown=function(a){switch(this.lastKeyDown=a.keyCode,a.keyCode){case b.ESC:this.dropdownEventWrapper(a,function(){this.hideDropdown()});break;case b.DOWN:this.dropdownEventWrapper(a,function(){this.selectOtherDropdownOption(function(a){return 0===a.next().length?a.siblings().first():a.next()})});break;case b.UP:this.dropdownEventWrapper(a,function(){this.selectOtherDropdownOption(function(a){return 0===a.prev().length?a.siblings().last():a.prev()})});break;default:return!0}},e.prototype.onRootKeydownEnter=function(b){this.dropdownEventWrapper(b,a.noop)},e.prototype.onDropdownHelpItemMousedown=function(b){this.dropdownEventWrapper(b,a.noop)},e.prototype.onDropdownItemMousedown=function(){var b=this;return function(c){c.preventDefault();var d=a(this).data("mentionable"),e=(new Date).getTime(),f=b.getWidthForInput(d.name),g='<input id="'+e+'" data-mentionable-id="'+d.id+'" value="'+d.name+'" style="width:'+f+'px;" class="mentioner__composer__mention js-mention" disabled />';b.editor.pasteHTML(g,{forcePlainText:!1,cleanAttrs:[]});var h=b.editor.exportSelection(),i=b.clearMentionTextTrigger(h);b.addBlankAfterMention(e),b.recalculateSelection(h,i),b.hideDropdown()}},e.prototype.recalculateSelection=function(a,b){var c=1,d=a.end-b.length+c;this.editor.importSelection({start:d,end:d})},e.prototype.addBlankAfterMention=function(b){var c=this.$root.find("#"+b),d=a("<span>&nbsp;</span>");d.insertAfter(c),d.replaceWith("&nbsp;")},e.prototype.clearMentionTextTrigger=function(a){var b=this.$root.text(),c=b.slice(0,a.end),d=c.lastIndexOf(this.mentionSymbol),e=c.slice(d,a.end),f=this.replaceNbspEntities(e,"&nbsp;"),g=new RegExp("("+f+")(<input)"),h=this.$root.html().replace(g,function(a,b,c){return c});return this.$root.html(h),e},e.prototype.getWidthForInput=function(b){var c=a('<span style="visibility: hidden;"></span>').text(b);this.$root.append(c);var e=c.width();return c.remove(),e+d},e.prototype.search=function(a){var b=this,c=b.escapeRegExp(b.replaceNbspEntities(a)),d=b.mentionables.filter(function(a){return b.matcher.call(b,a,c)}).slice(0,b.maxMentionablesToShow);d.length>0?b.showDropdownCandidates(d,c):b.hideDropdown()},e.prototype.replaceAt=function(a,b,c){return a.slice(0,b)+c+a.slice(b+1)},e.prototype.replaceNbspEntities=function(a,b){b=b||" ";var c=String.fromCharCode(160),d=a.indexOf(c);return d>-1?a.length>1?this.replaceAt(a,d,b):b:a},e.prototype.escapeRegExp=function(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},e.prototype.$parentWrapper=function(){return this.$root.parent()},e.prototype.$dropdown=function(){return this.$parentWrapper().find("."+c.DROPDOWN)},e.prototype.getDropdownOptions=function(){return this.$dropdown().find("."+c.DROPDOWN_ITEM)},e.prototype.showDropdownCandidates=function(a,b){var d=this.getDropdownOptionsToAppend(a),e=this.$dropdown();e.find("."+c.DROPDOWN_HELP_ITEM).remove(),e.append(d),this.highlightDropdownOptions(d,b),this.removeOrphanDropdownOptions(a),this.checkSelectedDropdownOption(),this.showDropdown(e)},e.prototype.showDropdownHelp=function(){var b=a(['<li class="'+c.DROPDOWN_HELP_ITEM+' mentioner__dropdown__item mentioner__dropdown__item--help">',this.dropdownHelpMessage,"</li>"].join("")),d=this.$dropdown().empty();d.append(b),this.showDropdown(d)},e.prototype.showDropdown=function(a){a.attr("style",this.getStyleForDropdown()),a.removeClass("mentioner__dropdown--hidden")},e.prototype.getDropdownOptionsToAppend=function(b){var c=this;return b.map(function(b){var d=c.getDropdownOptions().filter(function(){var c=a(this).data("mentionable");return c.id===b.id});return 0!==d.length?(d.find("p").html(b.name),d):c.createDropdownOption(b)})},e.prototype.highlightDropdownOptions=function(a,b){a.forEach(function(a){var c=a.find("p"),d=c.html(),e=d.toLowerCase().indexOf(b.toLowerCase()),f=d.slice(e,e+b.length),g=d.replace(f,'<span class="mentioner__dropdown__item__name__highlight">'+f+"</span>");c.html(g)})},e.prototype.removeOrphanDropdownOptions=function(b){this.getDropdownOptions().each(function(){var c=a(this).data("mentionable"),d=b.filter(function(a){return a.id===c.id})[0];d||a(this).remove()})},e.prototype.createDropdownOption=function(b){var d=a('<li class="'+c.DROPDOWN_ITEM+' mentioner__dropdown__item"></li>'),e=a('<p class="mentioner__dropdown__item__name">'+b.name+"</p>"),f=a(['<div class="mentioner__dropdown__item__avatar">','<img class="mentioner__dropdown__item__avatar__image" src="'+b.avatar+'" />',"</div>"].join("\n"));return d.append(f),d.append(e),d.data("mentionable",b),d},e.prototype.checkSelectedDropdownOption=function(){var b=this.getSelectedDropdownOption();if(0===b.length){var c=a(),d=this.getDropdownOptions().first();this.selectDropdownOption(c,d)}},e.prototype.getSelectedDropdownOption=function(){return this.$dropdown().find(".mentioner__dropdown__item--selected")},e.prototype.getStyleForDropdown=function(){var a=this.$root.outerHeight()+10,b=this.$root.offset().left-this.$root.parent().offset().left;return"top: "+a+"px; left: "+b+"px;"},e.prototype.hideDropdown=function(){var a=this.$dropdown();a.addClass("mentioner__dropdown--hidden")},e.prototype.isDropdownDisplayed=function(){return!this.$dropdown().hasClass("mentioner__dropdown--hidden")},e.prototype.selectOtherDropdownOption=function(a){var b=this.getSelectedDropdownOption(),c=0===b.siblings().length?b:a.call(this,b);this.selectDropdownOption(b,c)},e.prototype.selectDropdownOption=function(a,b){a.removeClass("mentioner__dropdown__item--selected"),b.addClass("mentioner__dropdown__item--selected")},e.prototype.serialize=function(){return this.$root.html()},e.prototype.getMentions=function(){var b=this,c=b.$root.find("input");return a.makeArray(c).map(function(c){var d=a(c).data("mentionableId"),e=b.mentionables.filter(function(a){return a.id===d});return e[0]})},e.prototype.triggerMention=function(){this.lastKeyDown=null,this.editor.cleanPaste(this.mentionSymbol)};var f=function(a,b){this.mentioner=new e(a,b)};f.prototype.serialize=function(){return this.mentioner.serialize()},f.prototype.getMentions=function(){return this.mentioner.getMentions()},f.prototype.triggerMention=function(){this.mentioner.triggerMention()},a.fn.mentioner=function(b){if("object"==typeof b)return this.each(function(){var c=a(this);void 0===c.data("mentioner")&&c.data("mentioner",new f(c,b))});if("string"==typeof b){var c=a(this).data("mentioner");if(c&&"function"==typeof c[b])return c[b]()}}}(jQuery);